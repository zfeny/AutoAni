# AutoAni 运行指南

## 快速启动

### 一键启动整个系统

```bash
python run.py
```

这会同时启动：
- ✅ Telegram Bot 监听
- ✅ 定时 RSS 刮削
- ✅ 定时刮削剧集信息
- ✅ 定时推送离线下载
- ✅ 定时检测下载完成（带通知）
- ✅ 定时检测下载失败（超时回退）

## 功能说明

### 1. 定时任务

系统会自动执行以下定时任务：

| 任务 | 默认间隔 | 说明 |
|------|---------|------|
| RSS刮削 | 30分钟 | 拉取订阅RSS，更新series表 |
| 推送下载 | 10分钟 | 推送pending剧集到OpenList（每次5个） |
| 检测完成 | 5分钟 | 检测downloading剧集是否下载完成，发送通知 |
| 检测失败 | 60分钟 | 检测超过1天的downloading，回退为pending |

### 2. 通过 Bot 管理

在 Telegram Bot 中：
- 发送 `/start` 打开主菜单
- 点击「⚙️ 设置」进入设置页
- 可以修改定时任务间隔
- 可以手动立即触发任务

#### 设置页功能

**⏰ 定时任务设置**
- 修改各个任务的执行间隔
- 重置为默认配置

**▶️ 手动执行任务**
- RSS刮削：立即拉取RSS更新订阅
- 刮削剧集：立即更新所有订阅的剧集信息
- 推送下载：立即推送待下载剧集
- 检测完成：立即检测下载完成的剧集
- 检测失败：立即检测超时的下载任务

### 3. 自动通知

当剧集下载完成时，Bot 会自动推送通知：

**单集通知**：
```
✅ 下载完成

🎬 番剧名称
📺 EP05

已添加到 OpenList
```

**批量通知**（多个剧集同时完成）：
```
✅ 下载完成 (3 集)

🎬 番剧A
   EP05, EP06

🎬 番剧B
   EP03
```

## 配置文件

### 定时任务配置

配置文件位置：`data/scheduler_config.json`

默认配置：
```json
{
  "rss_scrape_interval": 30,
  "push_download_interval": 10,
  "check_complete_interval": 5,
  "check_failed_interval": 60
}
```

可通过以下方式修改：
1. 直接编辑 JSON 文件（需要重启系统）
2. 通过 Bot 设置页修改（立即生效）

## 其他启动方式

### 仅启动 Bot（不启动调度器）

```bash
python run_bot.py
```

### 仅启动调度器（不启动 Bot）

```bash
python main.py
```

### 手动执行任务

使用 autoani_manual.py：

```bash
# 查看所有命令
python autoani_manual.py --help

# 刮削 RSS
python autoani_manual.py rebuild-subscriptions

# 刮削剧集
python autoani_manual.py scrape-episodes

# 推送下载（限制5个）
python autoani_manual.py push-downloads --limit 5

# 检测下载状态
python autoani_manual.py check-downloads
```

## 停止系统

按 `Ctrl+C` 停止系统，调度器和 Bot 会优雅退出。

## 日志查看

系统运行时会输出以下日志：

```
============================================================
[RSS刮削] 2025-01-05 12:00:00
============================================================
拉取到 15 个条目
去重后剩余 5 个番剧
...
[RSS刮削] 完成

============================================================
[推送下载] 2025-01-05 12:10:00
============================================================
找到 12 个缺失剧集
限制推送 5 个
推送: 番剧A EP01
  ✓ 添加离线下载成功
...
[推送下载] 完成

============================================================
[检测完成] 2025-01-05 12:15:00
============================================================
找到 3 个 downloading 剧集
重新扫描 OpenList...
✓ 番剧A EP01 - 下载完成
✓ 番剧B EP02 - 下载完成
✗ 番剧C EP03 - 下载失败，回退为 pending

✓ 已发送 Telegram 通知
[检测完成] 完成
```

## 故障排查

### Bot 无响应

1. 检查 Token 配置是否正确
2. 检查网络连接
3. 查看终端日志输出

### 定时任务未执行

1. 确认系统正在运行（查看终端输出）
2. 通过 Bot 设置页查看当前配置
3. 手动触发任务测试

### 通知未收到

1. 确认 `TELEGRAM_ALLOWED_USERS` 配置正确
2. 检查 Bot Token 是否有效
3. 查看终端是否有错误信息

### 调度器配置未生效

1. 通过 Bot 修改配置后会立即生效
2. 手动修改 JSON 文件需要重启系统
3. 确认 `data/scheduler_config.json` 文件格式正确

## 推荐配置

根据实际需求调整间隔时间：

**高频更新（追新番）**：
- RSS刮削：15分钟
- 推送下载：5分钟
- 检测完成：3分钟

**普通使用**：
- RSS刮削：30分钟（默认）
- 推送下载：10分钟（默认）
- 检测完成：5分钟（默认）

**低频使用（资源节约）**：
- RSS刮削：60分钟
- 推送下载：30分钟
- 检测完成：15分钟

检测失败间隔建议保持 60 分钟，避免频繁检查。
